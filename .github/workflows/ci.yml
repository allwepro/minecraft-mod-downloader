name: Rust CI

on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'src/**'
      - 'Cargo.toml'

permissions:
  contents: read

env:
  RUSTC_WRAPPER: sccache
  SCCACHE_DIR: /home/runner/.cache/sccache
  SCCACHE_IDLE_TIMEOUT: 0

jobs:
  prepare:
    name: Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      cargo-lock-hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v4
      - id: hash
        run: echo "hash=${{ hashFiles('**/Cargo.lock') }}" >> $GITHUB_OUTPUT

  fmt:
    name: Rust Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.89.0
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Rust Linter Check
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest] #, macos-latest, windows-latest
        rust: [1.89.0]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6
        with:
          use-gh-actions-cache: false

      - uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ matrix.os }}-${{ matrix.rust }}-${{ needs.prepare.outputs.cargo-lock-hash }}
          restore-keys: |
            sccache-${{ matrix.os }}-${{ matrix.rust }}-

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.os }}-clippy-${{ matrix.rust }}-${{ needs.prepare.outputs.cargo-lock-hash }}
          restore-keys: |
            ${{ matrix.os }}-clippy-${{ matrix.rust }}-

      - run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  audit:
    name: Rust Security + Dependencies Check
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6
        with:
          use-gh-actions-cache: false

      - uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: sccache-ubuntu-nightly-${{ needs.prepare.outputs.cargo-lock-hash }}
          restore-keys: |
            sccache-ubuntu-nightly-

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ubuntu-audit-${{ needs.prepare.outputs.cargo-lock-hash }}

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install Tools
        run: cargo binstall cargo-udeps cargo-audit -y

      - run: cargo +nightly udeps
      - run: cargo audit

  build_and_test:
    name: Rust Build & Test Check
    needs: [fmt, clippy, audit]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest] #, macos-latest, windows-latest
        rust: [1.89.0]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.6
        with:
          use-gh-actions-cache: false

      - uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: sccache-${{ matrix.os }}-${{ matrix.rust }}-${{ needs.prepare.outputs.cargo-lock-hash }}
          restore-keys: |
            sccache-${{ matrix.os }}-${{ matrix.rust }}-

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.os }}-build-${{ matrix.rust }}-${{ needs.prepare.outputs.cargo-lock-hash }}
          restore-keys: |
            ${{ matrix.os }}-build-${{ matrix.rust }}-

      - name: Build Release
        run: cargo build --release --verbose

      - name: Run Tests
        run: cargo test --workspace --all-features --verbose

      - name: Sccache Stats
        run: sccache --show-stats
